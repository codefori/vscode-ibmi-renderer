<head>
  <script src="{elements}" type="module"></script>
  <script src="{konva}"></script>
  <link rel="stylesheet" href="{styles}">
  <link rel="stylesheet" href="{codicon}" id="vscode-codicon-stylesheet">

  <script>
    // TODO: move to a separate file
    const vscode = acquireVsCodeApi();

    window.onload = () => {
      let pxwPerChar = 8.45;
      let pxhPerChar = 11;
      let dspfWidth = 80;
      let dspfHeight = 24;

      var width = dspfWidth * pxwPerChar;
      var height = dspfHeight * pxhPerChar;

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      const bg = new Konva.Rect({
        x: 0,
        y: 0,
        width: width,
        height: height,
        fill: 'black'
      });

      var layer = new Konva.Layer();
      layer.add(bg);

      var rectX = stage.width() / 2 - 50;
      var rectY = stage.height() / 2 - 25;

      function getNewSnapCords(x, y) {
        const newX = Math.round(x / pxwPerChar) * pxwPerChar;
        const newY = Math.round(y / pxhPerChar) * pxhPerChar;
        return { x: newX, y: newY };
      }

      function getLabelBox(row, col, text) {
        const width = text.length * pxhPerChar;
        const height = 11;

        var rectangle = new Konva.Group({
          x: (col - 1) * pxwPerChar,
          y: (row - 1) * pxhPerChar,
          width: width,
          height: height,
          draggable: true,
        });

        rectangle.on(`dragend`, e => {
          const { x, y } = e.target.attrs;
          console.log(x, y);
          const newCords = getNewSnapCords(x, y);
          e.target.to({
            x: newCords.x,
            y: newCords.y
          });
        })

        // add text to the label
        rectangle.add(new Konva.Text({
          text: text,
          fontSize: 14,
          fontFamily: `Consolas, "Liberation Mono", Menlo, Courier, monospace`,
          fill: 'green'
        }));

        // add cursor styling
        rectangle.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        rectangle.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });

        return rectangle;
      }

      var rectangleA = getLabelBox(1, 1, `12345678901234567890123456789012345678901234567890123456789012345678901234567890`);
      var rectangleB = getLabelBox(2, 1, `12345678901234567890123456789012345678901234567890123456789012345678901234567890`);

      layer.add(rectangleA);
      layer.add(rectangleB);
      stage.add(layer);
    };
  </script>
</head>

<!-- https://vscode-elements.github.io/guides/getting-started/ -->

<body>
  <div id="chat-container">
    <vscode-tabs panel selected-index="0" fixed-pane="start">
      <vscode-tab-header slot="header">RCDFMT</vscode-tab-header>
      <vscode-tab-header slot="header">HEADER</vscode-tab-header>
      <vscode-tab-header slot="header">FOOTER</vscode-tab-header>
    </vscode-tabs>

    <vscode-split-layout>
      <div slot="start">
        <div id="container" style="margin: 2em"></div>
      </div>

      <div slot="end">
        <vscode-form-group variant="settings-group">
          <vscode-label for="settings-textfield-01">
            Field name
          </vscode-label>
          <vscode-textfield id="settings-textfield-01" placeholder="TEXT01"></vscode-textfield>
        </vscode-form-group>
      </div>
    </vscode-split-layout>

  </div>
</body>